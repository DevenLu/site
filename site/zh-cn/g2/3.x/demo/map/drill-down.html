<!--
index: 2
title: 中国地图-省市下钻
resource:
  jsFiles:
    - ${url.dataSet}
    - ${url.jquery}
    - https://a.alipayobjects.com/g/datavis/china-geojson/1.0.0/index.js
plotDescription: 中国地图-省市下钻
plotUsage: 可视化的方法显示地理区域上的数据。 使用地图作为背景，通过图形的位置来表现数据的地理位置， 通常来展示数据在不同地理区域上的分布情况。
relativePlots:
  - ${plotByName.map}
-->

<script>
  $('#mountNode').html('<div style="position:relative;padding-left:250px;">' +
    '<div id="china" style="position: absolute;top:5px;left:5px;"></div>' +
    '<div id="province"></div>' +
  '</div>');
  let provinceChart;
  function processData(mapData) {
    // 构造虚拟数据
    const userData = [];
    const features = mapData.features;
    for (let i = 0; i < features.length; i++) {
      const name = features[i].properties.name;
      userData.push({
        name: name,
        value: Math.round(Math.random() * 1000),
      });
    }
    const ds = new DataSet();
    const geoDataView = ds.createView().source(mapData, {
      type: 'GeoJSON',
    }); // geoJSON 经纬度数据

    // 用户数据
    const dvData = ds.createView().source(userData);
    dvData.transform({
      type: 'geo.region',
      field: 'name',
      geoDataView: geoDataView,
      as: ['longitude', 'lantitude'],
    });

    return dvData;
  }

  function renderProvinceChart(name) {
    const provinceData = ChinaGeoJSON[name];
    provinceChart && provinceChart.destroy();
    provinceChart = null;
    if (!provinceData) {
      return;
    }
    const dv = processData(provinceData);

    // start: 计算地图的最佳宽高
    const longitudeRange = dv.range('longitude');
    const lantitudeRange = dv.range('lantitude');
    const ratio = (longitudeRange[1] - longitudeRange[0]) / (lantitudeRange[1] - lantitudeRange[0]);
    let width;
    let height;
    if (ratio > 1) {
      width = 450;
      height = width / ratio;
    } else {
      width = 350 * ratio;
      height = 350;
    }
    // end: 计算地图的最佳宽高

    provinceChart = new G2.Chart({
      container: 'province',
      width,
      height,
      padding: 0
    });
    provinceChart.source(dv);
    provinceChart.axis(false);
    provinceChart.tooltip({
      showTitle: false,
    });
    provinceChart
      .polygon()
      .position('longitude*lantitude')
      .label('name', {
        textStyle: {
          fill: '#fff',
          fontSize: 10,
          shadowBlur: 2,
          shadowColor: 'rgba(0, 0, 0, .45)'
        },
      })
      .style({
        stroke: '#fff',
        lineWidth: 1,
      })
      .color('value', '#BAE7FF-#1890FF-#0050B3');
      provinceChart.render();
  }

  const mapData = ChinaGeoJSON['China'];
  const chinaDv = processData(mapData);
  const longitudeRange = chinaDv.range('longitude');
  const lantitudeRange = chinaDv.range('lantitude');
  const ratio = (longitudeRange[1] - longitudeRange[0]) / (lantitudeRange[1] - lantitudeRange[0]);

  const chart = new G2.Chart({
    container: 'china',
    width: 250,
    height: 250 / ratio,
    padding: 0,
    animate: false
  });

  chart.source(chinaDv);
  chart.tooltip({
    showTitle: false,
  });
  chart.axis(false);
  chart
    .polygon()
    .position('longitude*lantitude')
    .tooltip('name')
    .style({
      stroke: '#bfbfbf',
      lineWidth: 1,
      fill: '#e3e3e3',
      globalAlpha: 0.85,
      cursor: 'pointer', // 设置鼠标手势
    })
    .select({
      // 设置是否允许选中以及选中样式
      mode: 'single', // 多选还是单选
      style: {
        fill: '#1890ff', // 选中的样式
      },
    });
  chart.render();

  const shapes = chart.getAllGeoms()[0].getShapes();
  for (let i = 0, len = shapes.length; i < len; i++) {
    const shape = shapes[i];
    const origin = shape.get('origin')['_origin'];
    const name = origin.name;
    if (name === '浙江') {
      renderProvinceChart(name);
      chart.getAllGeoms()[0].setShapeSelected(shape);
    }
  }

  chart.on('plotclick', function(ev) {
    const shape = ev.shape;
    if (!shape || !shape.name) {
      return false;
    }
    if (shape.get('selected')) {
      const item = shape.get('origin');
      const data = item['_origin'];
      const name = data.name;
      renderProvinceChart(name);
    } else {
      provinceChart && provinceChart.clear();
    }
  });
</script>
