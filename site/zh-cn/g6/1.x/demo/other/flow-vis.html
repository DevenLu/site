<!--
title: 流布局可视化
description: 
index: 1
resource:
  jsFiles:
    - ${url.jquery}
-->

<script type="text/javascript">
$.getJSON('/assets/data/flow-vis.json',function(data){
  var Util = G6.Util;
  var Layout = G6.Layout;
  var margin = 80;
  var height = 600 - 2 * margin;
  var width = 500 - 2 * margin;
  var layout = new Layout.Flow({
    nodes: Util.clone(data.nodes),
    edges: Util.clone(data.edges),
    calculationTimes: 1
  });
  var i = 1;
  var spacing = 200;

  data.edges.map(function(edge){
    edge.shape = 'line';
  });

  // 自定义节点
  G6.registNode('circle', {
    getAnchorPoints: function() {
      return [
        [1, 0.5], // 右边边的中点
        [0, 0.5] // 左边边的中点
      ];
    }
  }, 'circle');


  // 自定义边
  G6.registEdge('customeEdge', {
    draw: function(cfg, group){
      var points = cfg.points;
      var start = points[0];
      var end = points[points.length-1];
      var center = {
        x: (start.x + end.x)/2,
        y: (start.y + end.y)/2
      };
      var keyShape;
      var attrPoints;

      keyShape = group.addShape('polyline',{
        attrs: {
          points: [
            [start.x, start.y],
            [center.x, start.y],
            [center.x, end.y],
            [end.x, end.y]
          ],
          stroke: 'black'
        }
      });
      return keyShape;
    }
  });
  var net = new G6.Net({
    id: 'mountNode',           // 容器ID
    height: window.innerHeight         // 画布高
  });
  net.source(data.nodes, data.edges);
  net.node().color('label', function(val){
    var num = Number(val);
    if(parseInt(num/10, 10) === 0){
      return '#DC554C';
    }
    if(parseInt(num/10, 10) === 2){
      return '#FECD52';
    }
    if(parseInt(num/10, 10) === 3){
      return '#239F60';
    }
    if(parseInt(num/10, 10) === 4){
      return '#508FF2';
    }
  });
  net.render();
  layout.onNodeChange = function(id, point){
    setTimeout(function(){
      var node = net.find(id);
      net.update(node, {
        x: point.y * height + margin,
        y: point.x * width + margin
      });
      net.refresh();
    }, spacing*i);
    i++;
  };
  layout.start();
});
</script>
