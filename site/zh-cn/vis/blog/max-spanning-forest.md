<!--
index: 8
title: 一种带权图的可视分析方案
authors:
  - name: 有田
    avatar: ${assets}/image/members/youtian.jpg
date: "2017-11-18"
landscape: ${assets}/image/vis/blog/maxspanningForest.jpg
-->

## 概述

在互联网公司工作，我们常会遇到带权的关系网络数据。比如：系统之间的调用数据，用户的页面访问数据，知识图谱等等。这时候为了人能洞悉这些关系数据，我们就要对其进行图可视化。本文旨在提供一种`优雅的`、`实用的`对带权简单图的可视分析方案。

## 为何别人的网络图层次分明，我的却是一坨饼？

图可视化中，如果不对关系数据做任何解释，`力导`布局大概是最通用，且最常用的布局算法。有时我们预想中的力导布局结果大概是这样的：

![image | 300*300](https://gw.alipayobjects.com/zos/rmsportal/jIwxNmtPKSCHujREyYNA.png)

但真实业务中的网络数据，有时候不管我们使用哪一种力导布局算法，不管怎么调整布局的参数，布局出的结果就是`一坨饼`。

![image | 300*300](https://gw.alipayobjects.com/zos/rmsportal/VtAHVHkxZHRRHJabmrNZ.png)

## 问题在哪里？

稍作探究，不难发现力导算法多种多样，但万变不离其宗，其最根本的思想，还是基于引斥力的相互作用的物理模型。再稍作查阅，我们发现不论是哪种布局算法，只要其数据越接近一棵树其布局结果就会越有层次，其聚类效果越好，观感上也越符合人的审美。

## 从网中抽离出一棵树？

可视化设计中有一个重要原则，即是`不能为了美而美`（虽说大多数时候，美的即是合理的）。首先我们要考究在网络数据中抽离出一棵树是否有意义。

实践中，我们发现在页面流量、系统调用、社交传播等图分析场景中，往往会关注`最大路径`的概念，而且上述场景，其真实结构往往就是一棵树。经检验我们可以得出：对带权图而言多数场景下，从网络数据中抽离一颗最大生成树能帮助有效用户发现系统的最大路径，并且这也是分析者所最关心的。

## 从网中抽离出一棵树

### 无向图

无向图的最大（小）生成树的问题和解法非常成熟，用 [prim](https://en.wikipedia.org/wiki/Prim) 、[Kruskal](https://en.wikipedia.org/wiki/Kruskal%27s_algorithm) 等算法均能快速有效的从一个连通图中抽离一棵生成树，这块本文不做重点讨论。

### 有向图

图论中，无向图有最小（大）生成树问题，有向图有最小（大）树形图问题。但很可惜，在真实的业务场景中，我们的问题域可能既不在单纯的有向图，又不在单纯的无向图。是一个介于二者之间的问题。首先从可视化的角度先明确三个基础目标。

【目标一】第一视图中必须展示出所有节点
【目标二】第一视图中展示的图结构是树形的
【目标三】边的方向大于边的权重

明确了这三个目标后，我们的实施步骤就有了依据，具体步骤如下：

#### 步骤一：将权重最大的节点视为根节点

即使将权重最高的节点视为根节点。

#### 步骤二：参考 prim 算法从连通图中抽离生成树

思路如下：
* 取遍历方向的正方向最大权重边作为树边
* 若无遍历正方向边，则去反向边权重最大边为树边

这步可能晦涩一点，也是本文的重点，这里展开讨论一下：

Prim 最大生成树算法：

![image|200*200](https://gw.alipayobjects.com/zos/rmsportal/CasFSuhRUJFGvWIbnIgJ.gif)

由该算法的定义可知，改算法会不断的从树主干出发，选取权重最大的、能成为树的边。我们为了达到【目标三】，会在这部加入方向因素，意味者我们将优先选择从主干指向下一个节点的边。如果无符合要求的有向边，如下图节点 4 与 节点 2 这样，则为了达到【目标一】，我们将选取该反向边为树形图的边。

![image](https://gw.alipayobjects.com/zos/rmsportal/ROzwVwEhpdBSJyuwXZcU.png)

经过上述两步，我们便能从一个连通图抽离出一个树形图：

![image](https://gw.alipayobjects.com/zos/rmsportal/EuqFdpBcBFVHKcgIssBi.png)

![iamge](https://gw.alipayobjects.com/zos/rmsportal/ALTxYRrzXaVXzqagLVCd.png)

## 优化

### 拓展为森林

抽离树形图只能在连通图内进行，为应对更一般的场景，需要在抽离前对图进行连通子图的拆分。既能得到最大生成森林。

### 加上交互显示隐藏非树形边

![image](https://gw.alipayobjects.com/zos/rmsportal/iCPaZaXYtKjNAMyuapcc.gif)

## 总结

经事件检验，该方案有以下优点：

1. 突出主要路径
2. 优化布局效果
3. 节省布局时间

不失为一种优雅的、通用的对带权图的解决方案。该方案已经沉淀为 G6 插件。有需要的朋友可以轻易的直接复用。
